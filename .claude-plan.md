# Plan: F.6 Safe Reference Removal + Stale Preview Bugfix

## Document Review Acknowledgement

Explicitly confirmed review of all six required files:
1. ✅ docs/shot-editor-v3-ia.md
2. ✅ design-spec.md
3. ✅ shot-editor-v3-phase1.md
4. ✅ shot-editor-v3-phase2.md (includes prior F.5-bugfix attempt)
5. ✅ shot-editor-v3-phase3.md
6. ✅ docs/claude-code-tooling.md

---

## Problem Statement

**Bug**: Deleted reference images are STILL appearing as the preview image on shot cards in ShotsPage. This violates the truth contract.

**Safety Gap**: The current "X" button performs instant, irreversible deletion without confirmation.

---

## Investigation Summary

### Code Reviewed

1. **ShotLooksCanvas.jsx** (lines 1018-1034):
   - `handleRemoveReference` removes reference from `look.references[]`
   - Clears `displayImageId` if removing current display image
   - Uses immediate `saveLooks()` (not debounced)

2. **ShotsPage.jsx** (lines 3845-3902):
   - `selectShotImage()` has defensive check: verifies `displayImageId` resolves to existing reference
   - If missing, falls back to next priority (hero product → first reference → legacy fields)

3. **F.5-bugfix** already claimed to fix this by switching to immediate save. But bug persists.

### Hypothesis: Suspected Root Causes

1. **React/TanStack Query stale cache**: The `useShots` hook provides data to ShotsPage. After a reference is deleted in the editor, navigating back may show stale cached data until refetch completes.

2. **Object identity memoization**: `useMemo(() => selectShotImage(shot, products), [shot, products])` only recalculates if object references change. If the parent component passes the same shot object reference (shallow equality), the image path won't update.

3. **Legacy fields not cleared**: If `shot.attachments` or `shot.referenceImagePath` contains a URL that was also used as a look reference, deleting from `look.references` doesn't clear these legacy fields (Priorities 4-5 in fallback).

---

## Implementation Plan

### Part A: Reproduce and Diagnose Bug (via Claude-in-Chrome)

1. Navigate to ShotsPage, select a shot
2. Open in Shot Editor V3
3. Upload a reference image to a Look
4. Set it as display image (star icon)
5. Delete the reference (X button)
6. Navigate back to ShotsPage immediately
7. **Observe**: Does the card still show the deleted image?
8. Refresh the page
9. **Observe**: Does the card update after refresh?
10. Inspect Firestore document to verify persisted state

### Part B: Safety - Add Confirmation Dialog

**File**: `src/components/shots/workspace/ShotLooksCanvas.jsx`

**Change**: In `LookReferencesSection`, modify the remove button to show confirmation before deletion.

**Approach**:
- Import `showConfirm` from `lib/toast`
- On X button click, show confirm dialog: "Remove this reference image?"
- Buttons: Cancel / Remove
- Only proceed with `onRemoveReference()` if confirmed

**Design rationale**:
- Matches existing app patterns (showConfirm used elsewhere)
- Non-dramatic confirmation language
- No recycle bin / restore (explicitly deferred per requirements)

### Part C: Fix Stale Preview (pending diagnosis)

Based on investigation findings, potential fixes:

**Option C1** (if cache issue): Force query invalidation in `saveLooks()`
**Option C2** (if memoization issue): Ensure shot object reference changes after save
**Option C3** (if legacy fields): Clear `referenceImagePath`/`attachments` when source reference deleted

Will determine correct fix after browser investigation.

---

## Explicitly NOT Implementing

- ❌ Recycle bin / restore functionality
- ❌ TTL-based deletion
- ❌ Schema changes
- ❌ New Firestore collections
- ❌ Undo functionality

---

## Files Expected to Change

1. `src/components/shots/workspace/ShotLooksCanvas.jsx` - Add confirmation dialog
2. `src/pages/ShotsPage.jsx` - Potentially fix cache/memoization issue (TBD after diagnosis)
3. `shot-editor-v3-phase2.md` - Document this delta

---

## Verification Plan

1. **Claude-in-Chrome visual verification**:
   - Upload reference → set as display → delete → verify preview changes immediately
   - Verify switching views doesn't resurrect stale preview
   - Verify confirmation dialog appears on delete

2. **Lint + Build**:
   - `npm run lint` must pass
   - `npm run build` must pass

---

## Delta Designation

This will be logged as **F.6 Safe Reference Removal** in shot-editor-v3-phase2.md.
