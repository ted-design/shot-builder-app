#!/usr/bin/env bash
set -euo pipefail

# ──────────────────────────────────────────────
# pre-push hook: block pushes to main/master
# Checks both current branch and destination ref.
# ──────────────────────────────────────────────

PROTECTED_BRANCHES="^(main|master)$"

branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD)

# Block if current branch is main/master
if echo "$branch" | grep -qE "$PROTECTED_BRANCHES"; then
  echo ""
  echo "ERROR: Push blocked — you are on the protected branch '$branch'."
  echo ""
  echo "  All work must happen on a feature branch (e.g. vnext/*)."
  echo "  To create a new branch:  git checkout -b vnext/your-feature"
  echo ""
  echo "  To bypass this hook (NOT recommended):"
  echo "    git push --no-verify"
  echo "  To disable hooks entirely:"
  echo "    bash scripts/disable-githooks.sh"
  echo ""
  exit 1
fi

# Parse stdin: each line is "local_ref local_sha remote_ref remote_sha"
# Block if any destination ref targets main or master
while read -r local_ref local_sha remote_ref remote_sha; do
  remote_branch="${remote_ref#refs/heads/}"
  if echo "$remote_branch" | grep -qE "$PROTECTED_BRANCHES"; then
    echo ""
    echo "ERROR: Push blocked — destination ref '$remote_branch' is protected."
    echo ""
    echo "  You cannot push directly to '$remote_branch'."
    echo "  Push to your feature branch and open a Pull Request instead."
    echo ""
    echo "  To bypass this hook (NOT recommended):"
    echo "    git push --no-verify"
    echo "  To disable hooks entirely:"
    echo "    bash scripts/disable-githooks.sh"
    echo ""
    exit 1
  fi
done

exit 0
