# Context Sentry

A Claude Code hook that monitors transcript size and reminds Claude to checkpoint its progress before context degrades.

## What It Does

When the transcript file exceeds a configurable size threshold, the hook injects an `additionalContext` message into Claude's context instructing it to write/update:

- `docs/_runtime/CHECKPOINT.md` — decisions, completed work, key file paths
- `docs/_runtime/HANDOFF.md` — next steps, do-not list, verification checklist

These files are **runtime artifacts** generated by Claude during a session. They are gitignored and never committed.

The hook never blocks tool calls. It only adds a reminder to Claude's context.

## How It Works

1. Runs as a `PreToolUse` hook on mutating tools (Bash, Write, Edit, NotebookEdit) and as a `PreCompact` hook before context compaction.
2. Reads the transcript file size as a proxy for context fullness.
3. If size exceeds threshold and backoff conditions are met, emits a JSON payload with `additionalContext`.
4. Prints a trigger line to stderr for observability.

### Self-Trigger Guard

When Claude writes to `CHECKPOINT.md` or `HANDOFF.md` (at any path), the hook exits silently to avoid recursion.

### Nag Backoff

After triggering, the hook suppresses further warnings for N minutes OR until the transcript grows by an additional delta. State is persisted in `.claude/.context_sentry_state.json`.

## Configuration

All tuning is via environment variables (set in your shell profile or per-session):

| Variable | Default | Description |
|----------|---------|-------------|
| `CONTEXT_SENTRY_THRESHOLD_KB` | `200` | Transcript size threshold in KB |
| `CONTEXT_SENTRY_BACKOFF_MIN` | `10` | Minutes between repeated warnings |
| `CONTEXT_SENTRY_BACKOFF_DELTA_KB` | `50` | Additional growth (KB) that re-triggers warning |
| `CONTEXT_SENTRY_DEBUG` | (unset) | Set to `1` for extra stderr diagnostics |

## Enable / Disable

**Enabled by default** when `.claude/settings.local.json` contains the hook entries (this file is gitignored and local-only).

To disable temporarily, add to `.claude/settings.local.json`:

```json
{
  "disableAllHooks": true
}
```

Or remove the `hooks` section entirely.

## Dry-Run Test

Clear any existing backoff state first:

```bash
rm -f .claude/.context_sentry_state.json
```

### Test 1: Trigger on large transcript

```bash
dd if=/dev/zero of=/tmp/cs_test_transcript bs=1024 count=250 2>/dev/null

echo '{
  "session_id": "test",
  "transcript_path": "/tmp/cs_test_transcript",
  "cwd": ".",
  "hook_event_name": "PreToolUse",
  "tool_name": "Bash",
  "tool_input": {"command": "echo hello"}
}' | python3 .claude/hooks/context_sentry.py 2>/tmp/cs_stderr
echo "Exit: $?"
echo "--- stdout (JSON payload) ---"
# (JSON output is on stdout from the pipe above)
echo "--- stderr ---"
cat /tmp/cs_stderr
```

Expected: JSON with `hookSpecificOutput.additionalContext` referencing `docs/_runtime/`, stderr trace line, exit 0.

### Test 2: Self-trigger guard (new runtime paths)

```bash
echo '{
  "session_id": "test",
  "transcript_path": "/tmp/cs_test_transcript",
  "cwd": ".",
  "hook_event_name": "PreToolUse",
  "tool_name": "Write",
  "tool_input": {"file_path": "/project/docs/_runtime/CHECKPOINT.md", "content": "test"}
}' | python3 .claude/hooks/context_sentry.py 2>&1
echo "Exit: $?"
```

Expected: no output, exit 0.

### Test 3: Backoff (run Test 1 again immediately)

```bash
echo '{
  "session_id": "test",
  "transcript_path": "/tmp/cs_test_transcript",
  "cwd": ".",
  "hook_event_name": "PreToolUse",
  "tool_name": "Bash",
  "tool_input": {"command": "echo hello"}
}' | python3 .claude/hooks/context_sentry.py 2>&1
echo "Exit: $?"
```

Expected: no output, exit 0 (backoff suppressed).

### Test 4: PreCompact event

```bash
rm -f .claude/.context_sentry_state.json

echo '{
  "session_id": "test",
  "transcript_path": "/tmp/cs_test_transcript",
  "cwd": ".",
  "hook_event_name": "PreCompact",
  "trigger": "auto"
}' | python3 .claude/hooks/context_sentry.py 2>/tmp/cs_stderr
echo "Exit: $?"
cat /tmp/cs_stderr
```

Expected: JSON with `hookEventName: "PreCompact"`, stderr trace, exit 0.

### Test 5: Missing transcript_path

```bash
echo '{
  "session_id": "test",
  "cwd": ".",
  "hook_event_name": "PreToolUse",
  "tool_name": "Bash",
  "tool_input": {"command": "echo hello"}
}' | python3 .claude/hooks/context_sentry.py 2>&1
echo "Exit: $?"
```

Expected: no output, exit 0.

## Files

| Path | Purpose | Committed |
|------|---------|-----------|
| `.claude/hooks/context_sentry.py` | Hook script | Yes |
| `docs/CONTEXT_SENTRY.md` | This documentation | Yes |
| `.claude/settings.local.json` | Hook wiring + permissions | No (gitignored) |
| `.claude/.context_sentry_state.json` | Backoff state | No (gitignored, auto-created) |
| `docs/_runtime/CHECKPOINT.md` | Checkpoint output | No (gitignored, runtime artifact) |
| `docs/_runtime/HANDOFF.md` | Handoff output | No (gitignored, runtime artifact) |
